name: Build & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --- install node manually, no setup-node auth injection ---
      - name: Install Node.js 18 (no auth)
        run: |
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node -v
          npm -v
          npm config set registry https://registry.npmjs.org/
          npm config delete '//registry.npmjs.org/:_authToken' || true
          rm -f ~/.npmrc .npmrc /home/runner/.npmrc || true

      # --- ensure no injected tokens from env or org secrets ---
      - name: Purge npm tokens from environment
        run: |
          unset NODE_AUTH_TOKEN
          unset NPM_TOKEN
          echo "Checking env..."
          env | grep -i npm || echo "✅ No npm env vars found"
          env | grep -i auth || echo "✅ No auth vars found"

      - name: Kill GitHub-injected npm tokens
        run: |
          unset NODE_AUTH_TOKEN
          unset NPM_TOKEN
          npm config delete '//registry.npmjs.org/:_authToken' || true
          echo "✅ Cleared all npm tokens"
          
      - name: Install frontend deps
        working-directory: frontend
        run: npm ci --ignore-scripts --no-audit --no-fund

      - name: Build (CRA)
        working-directory: frontend
        env:
          CI: "false"
          GENERATE_SOURCEMAP: "false"
          INLINE_RUNTIME_CHUNK: "false"
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: frontend/build
          if-no-files-found: error

      # ---------- BACKEND ----------
      - name: Install backend deps
        working-directory: backend
        run: npm ci --ignore-scripts --no-audit --no-fund

      - name: Prune dev deps
        working-directory: backend
        run: npm prune --production

      - name: Create backend bundle
        shell: bash
        run: |
          set -e
          rm -rf deploy && mkdir -p deploy
          tar -czf backend.tar.gz ecosystem.config.js backend
          mv backend.tar.gz deploy/

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-bundle
          path: deploy/backend.tar.gz
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-bundle
          path: backend-bundle

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Trust host
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Push artifacts
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            sudo mkdir -p /var/www/bmc /opt/bmc
            sudo chown -R $USER:$USER /var/www/bmc /opt/bmc
          '
          rsync -azh --delete web-build/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/bmc/
          rsync -azh backend-bundle/backend.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/backend.tar.gz

      - name: Deploy backend with PM2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'SSH'
          set -Eeuo pipefail
          APP_DIR="/opt/bmc"
          REL_DIR="$APP_DIR/releases"
          TS="$(date +%Y%m%d%H%M%S)"
          NEW_REL="$REL_DIR/$TS"
          APP_NAME="bmc-api"
          ECOS="$APP_DIR/current/ecosystem.config.js"

          mkdir -p "$REL_DIR" "$APP_DIR/shared"
          mkdir -p "$NEW_REL"
          tar -xzf /tmp/backend.tar.gz -C "$NEW_REL"

          if [ -f "$NEW_REL/backend/package.json" ]; then
            (cd "$NEW_REL/backend" && npm ci --omit=dev)
            (cd "$NEW_REL/backend" && npm ls @aws-sdk/client-ssm >/dev/null 2>&1 || npm i @aws-sdk/client-ssm)
          fi

          ln -sfn "$NEW_REL" "$APP_DIR/current"
          command -v pm2 >/dev/null 2>&1 || sudo npm i -g pm2

          pm2 delete "$APP_NAME" || true
          pm2 startOrReload "$ECOS" --env production --only "$APP_NAME"
          pm2 set pm2:autodump true
          pm2 save
          SSH

      - name: Reload NGINX
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            sudo nginx -t && sudo systemctl reload nginx
          '