name: Build & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json
          registry-url: 'https://registry.npmjs.org'

      - name: Verify npm auth
        working-directory: frontend
        run: |
          echo "----- npm registry -----"
          npm config get registry
          echo "----- whoami test -----"
          npm whoami || echo "not authenticated"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install frontend deps
        working-directory: frontend
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm ci

      - name: Build (CRA)
        working-directory: frontend
        env:
          CI: "false"
          GENERATE_SOURCEMAP: "false"
          INLINE_RUNTIME_CHUNK: "false"
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: frontend/build
          if-no-files-found: error

      # ---------- BACKEND ----------
      - name: Install backend deps
        working-directory: backend
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm ci

      - name: Prune dev deps
        working-directory: backend
        run: npm prune --production

      - name: Create backend bundle
        shell: bash
        run: |
          set -e
          rm -rf deploy && mkdir -p deploy
          tar -czf backend.tar.gz ecosystem.config.js backend
          mv backend.tar.gz deploy/

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-bundle
          path: deploy/backend.tar.gz
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-bundle
          path: backend-bundle

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Trust host
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Ensure remote dirs
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            sudo mkdir -p /var/www/bmc
            sudo mkdir -p /opt/bmc
            sudo chown -R $USER:$USER /var/www/bmc /opt/bmc
          '

      - name: Push artifacts
        run: |
          rsync -azh --delete web-build/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/bmc/
          rsync -azh backend-bundle/backend.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/backend.tar.gz

      - name: Install backend + PM2 reload
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} <<'SSH'
          # ... (same as your PM2 setup)
          SSH

      - name: Reload NGINX (serve new frontend)
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            sudo nginx -t && sudo systemctl reload nginx
          '
