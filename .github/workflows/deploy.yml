name: Build & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json
          registry-url: 'https://registry.npmjs.org'

      - name: Clean npm auth + config
        shell: bash
        run: |
          echo "Wiping global npm credentials..."
          rm -f ~/.npmrc
          rm -rf ~/.npm/_auth*
          npm config delete '//registry.npmjs.org/:_authToken' || true
          npm config set registry 'https://registry.npmjs.org'
          npm cache clean --force

      - name: Verify npm environment
        run: |
          echo "Registry:" $(npm config get registry)
          npm --version
          node --version

      - name: Install frontend deps
        working-directory: frontend
        run: |
          echo "Installing frontend dependencies..."
          npm ci
          ls -la node_modules/.bin | grep react-scripts || echo "⚠️ react-scripts not found!"

      - name: Build (CRA)
        working-directory: frontend
        env:
          CI: "false"
          GENERATE_SOURCEMAP: "false"
          INLINE_RUNTIME_CHUNK: "false"
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: frontend/build
          if-no-files-found: error

      # ---------- BACKEND ----------
      - name: Install backend deps
        working-directory: backend
        run: npm ci

      - name: Prune dev deps
        working-directory: backend
        run: npm prune --production

      - name: Create backend bundle
        shell: bash
        run: |
          set -e
          rm -rf deploy && mkdir -p deploy
          tar -czf backend.tar.gz ecosystem.config.js backend
          mv backend.tar.gz deploy/

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-bundle
          path: deploy/backend.tar.gz
          if-no-files-found: error